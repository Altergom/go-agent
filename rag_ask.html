<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAG å¬å›é—®ç­”</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: #1f2937;
      background: radial-gradient(1200px 600px at 10% 10%, #e0e7ff 0%, rgba(224,231,255,0) 60%),
                  radial-gradient(1200px 600px at 90% 20%, #fce7f3 0%, rgba(252,231,243,0) 55%),
                  #f7f7fb;
      min-height: 100vh;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
      font-weight: 700;
      color: #111827;
    }
    .brand-badge {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: linear-gradient(135deg, #667eea 0%, #8b5cf6 100%);
      display: inline-block;
    }
    .nav {
      display: flex;
      gap: 10px;
    }
    .nav a {
      text-decoration: none;
      color: #374151;
      padding: 8px 12px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
      font-size: 13px;
    }
    .nav a:hover {
      border-color: #c7d2fe;
      color: #4338ca;
      box-shadow: 0 4px 12px rgba(99,102,241,0.15);
    }
    .container {
      max-width: 980px;
      margin: 24px auto 40px;
      padding: 0 20px;
    }
    .hero {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 20px;
      align-items: center;
    }
    .hero-card {
      background: rgba(255,255,255,0.85);
      border: 1px solid #eef2ff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    .hero h1 {
      margin: 0 0 8px;
      font-size: 26px;
    }
    .hero p {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
      line-height: 1.6;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 18px;
    }
    .stat {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
    }
    .stat-title {
      color: #6b7280;
      font-size: 12px;
    }
    .stat-value {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
    }
    .panel {
      margin-top: 20px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 12px 30px rgba(17,24,39,0.06);
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .collection-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }
    .collection-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
    }
    .collection-name {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    .collection-meta {
      font-size: 12px;
      color: #6b7280;
    }
    textarea {
      width: 100%;
      min-height: 140px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      resize: vertical;
      font-size: 14px;
      font-family: inherit;
      background: #fafafa;
    }
    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 12px;
    }
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #8b5cf6 100%);
      color: #fff;
      box-shadow: 0 6px 14px rgba(99,102,241,0.25);
    }
    .btn-primary:hover { transform: translateY(-1px); }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }
    .btn-danger {
      background: #ef4444;
      color: #fff;
      box-shadow: 0 6px 14px rgba(239,68,68,0.2);
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .result {
      margin-top: 14px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      border-radius: 12px;
      padding: 14px;
      min-height: 120px;
      white-space: pre-wrap;
      font-family: Consolas, "SFMono-Regular", monospace;
      font-size: 12px;
      color: #111827;
    }
    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }
    @media (max-width: 900px) {
      .hero { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <span class="brand-badge"></span>
      <span>RAG é—®ç­”æ§åˆ¶å°</span>
    </div>
    <div class="nav">
      <a href="/rag_index.html">æ–‡æ¡£åµŒå…¥å…¥å£</a>
      <a href="#milvus-collections">é›†åˆç®¡ç†</a>
      <a href="/chat_test.html">èŠå¤©æµ‹è¯•é¡µ</a>
    </div>
  </div>

  <div class="container">
    <div class="hero">
      <div class="hero-card">
        <h1>çŸ¥è¯†åº“å¬å›é—®ç­”</h1>
        <p>ä»å·²åµŒå…¥çš„æ–‡æ¡£ä¸­æ£€ç´¢ä¿¡æ¯å¹¶ç”Ÿæˆç­”æ¡ˆï¼ˆéæµå¼è¾“å‡ºï¼‰ã€‚</p>
        <div class="stats">
          <div class="stat">
            <div class="stat-title">æ¨¡å¼</div>
            <div class="stat-value">Ask</div>
          </div>
          <div class="stat">
            <div class="stat-title">æ¥å£</div>
            <div class="stat-value">/api/rag/ask</div>
          </div>
        </div>
      </div>
      <div class="hero-card">
        <h1>å¿«é€Ÿå¼€å§‹</h1>
        <p>å…ˆå‰å¾€â€œæ–‡æ¡£åµŒå…¥å…¥å£â€ä¸Šä¼ æ–‡ä»¶ï¼Œç„¶åå›åˆ°æ­¤é¡µè¿›è¡Œæ£€ç´¢é—®ç­”ã€‚</p>
        <div class="stats">
          <div class="stat">
            <div class="stat-title">ä¸Šä¼ </div>
            <div class="stat-value">rag_index.html</div>
          </div>
          <div class="stat">
            <div class="stat-title">é—®ç­”</div>
            <div class="stat-value">rag_ask.html</div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel" id="milvus-collections">
      <div class="panel-header">
        <div>
          <h2>ğŸ§© Milvus é›†åˆç®¡ç†</h2>
          <div class="hint" id="collectionHint">æ­£åœ¨åŠ è½½é›†åˆåˆ—è¡¨...</div>
        </div>
        <button class="btn btn-secondary" id="collectionRefreshBtn">åˆ·æ–°</button>
      </div>
      <div class="collection-list" id="collectionList"></div>
    </div>

    <div class="panel">
      <textarea id="question" placeholder="è¯·è¾“å…¥é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæ–‡æ¡£ä¸­æåˆ°çš„ä¸»è¦ç»“è®ºæ˜¯ä»€ä¹ˆï¼Ÿ"></textarea>
      <div class="actions">
        <button id="askBtn" class="btn btn-primary" onclick="ask()">æäº¤é—®é¢˜ (æ™®é€š)</button>
        <button id="streamBtn" class="btn btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);" onclick="askStream()">æµå¼é—®ç­” (å¿«)</button>
        <button class="btn btn-secondary" onclick="clearResult()">æ¸…ç©ºç»“æœ</button>
      </div>
      <div class="hint">æç¤ºï¼šæµå¼é—®ç­”å¯ä»¥æ˜¾è‘—é™ä½é¦–å±ç­‰å¾…æ—¶é—´ã€‚</div>
      <div class="result" id="result">ç­‰å¾…æé—®...</div>
    </div>
  </div>

  <script>
    const resultEl = document.getElementById("result");
    const askBtn = document.getElementById("askBtn");
    const collectionListEl = document.getElementById("collectionList");
    const collectionHintEl = document.getElementById("collectionHint");
    const collectionRefreshBtn = document.getElementById("collectionRefreshBtn");

    async function ask() {
      const query = document.getElementById("question").value.trim();
      if (!query) {
        resultEl.textContent = "è¯·è¾“å…¥é—®é¢˜ã€‚";
        return;
      }

      askBtn.disabled = true;
      resultEl.textContent = "æŸ¥è¯¢ä¸­...";

      try {
        const res = await fetch("/api/rag/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query })
        });
        const data = await res.json();
        resultEl.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        resultEl.textContent = "æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
      } finally {
        askBtn.disabled = false;
      }
    }

    async function askStream() {
      const query = document.getElementById("question").value.trim();
      if (!query) {
        resultEl.textContent = "è¯·è¾“å…¥é—®é¢˜ã€‚";
        return;
      }

      const streamBtn = document.getElementById("streamBtn");
      streamBtn.disabled = true;
      resultEl.textContent = "";

      try {
        const response = await fetch("/api/rag/chat/stream", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split("\n");
          for (const line of lines) {
            if (line.startsWith("data: ")) {
              try {
                const data = JSON.parse(line.substring(6));
                resultEl.textContent += data.content;
              } catch (e) {}
            }
          }
        }
      } catch (e) {
        resultEl.textContent = "æµå¼è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
      } finally {
        streamBtn.disabled = false;
      }
    }

    function clearResult() {
      resultEl.textContent = "ç­‰å¾…æé—®...";
    }

    async function loadCollections() {
      collectionHintEl.textContent = "åŠ è½½ä¸­...";
      collectionListEl.innerHTML = "";
      collectionRefreshBtn.disabled = true;

      try {
        const res = await fetch("/api/milvus/collections");
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.message || "è·å–é›†åˆåˆ—è¡¨å¤±è´¥");
        }

        const names = Array.isArray(data.collections) ? data.collections : [];
        if (names.length === 0) {
          collectionHintEl.textContent = "æš‚æ— é›†åˆ";
          return;
        }

        collectionHintEl.textContent = `å…± ${names.length} ä¸ªé›†åˆ`;
        names.forEach((name) => {
          const item = document.createElement("div");
          item.className = "collection-item";

          const info = document.createElement("div");
          const title = document.createElement("div");
          title.className = "collection-name";
          title.textContent = name;
          const meta = document.createElement("div");
          meta.className = "collection-meta";
          meta.textContent = "å¯ç”¨äºå‘é‡æ£€ç´¢";
          info.appendChild(title);
          info.appendChild(meta);

          const action = document.createElement("div");
          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-danger";
          delBtn.textContent = "åˆ é™¤";
          delBtn.onclick = () => deleteCollection(name, delBtn);
          action.appendChild(delBtn);

          item.appendChild(info);
          item.appendChild(action);
          collectionListEl.appendChild(item);
        });
      } catch (e) {
        collectionHintEl.textContent = "åŠ è½½å¤±è´¥ï¼š" + e.message;
      } finally {
        collectionRefreshBtn.disabled = false;
      }
    }

    async function deleteCollection(name, buttonEl) {
      if (!window.confirm(`ç¡®å®šè¦åˆ é™¤é›†åˆ ${name} å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
        return;
      }

      buttonEl.disabled = true;
      try {
        const res = await fetch(`/api/milvus/collections/${encodeURIComponent(name)}`, {
          method: "DELETE"
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.message || "åˆ é™¤å¤±è´¥");
        }
        await loadCollections();
      } catch (e) {
        collectionHintEl.textContent = "åˆ é™¤å¤±è´¥ï¼š" + e.message;
      } finally {
        buttonEl.disabled = false;
      }
    }

    collectionRefreshBtn.addEventListener("click", loadCollections);
    loadCollections();
  </script>
</body>
</html>
